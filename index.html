<!DOCTYPE html>
<html lang="de">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Motorradtabelle</title>
  <style>
    table {
      border-collapse: collapse;
      font-family: Arial, sans-serif;
      table-layout: auto;
    }
    th, td {
      border: 1px solid #ddd;
      padding: 8px;
      text-align: center;
      white-space: nowrap;
    }
    th {
      background-color: #f2f2f2;
      cursor: pointer;
    }
    th:hover {
      background-color: #e0e0e0;
    }
    td.image-cell {
      padding: 6px;
      height: 60px;
      overflow: hidden;
      line-height: 0;
    }
    td.image-cell a {
      display: flex;
      justify-content: center;
      align-items: center;
      height: 100%;
      text-decoration: none;
      color: inherit;
    }
    td.image-cell img {
      display: block;
      max-width: 100%;
      max-height: 90px;
      height: auto;
      object-fit: scale-down;
      margin: 0 auto;
      border: none;
      padding: 0;
    }
  </style>
</head>
<body>

  <h2>Motorradtabelle</h2>

<!-- Eingabe- und Steuerungselemente -->
<div style="display: flex; flex-direction: column; align-items: flex-start; gap: 10px; margin: 10px 0;">
  <div style="display: flex; align-items: center; gap: 10px;">
    <label for="exportCodeField" style="min-width: 90px;">Export-Code:</label>
    <input type="text" id="exportCodeField" readonly style="width: 300px; padding: 5px;" />
    <button id="copyExportBtn" style="width: 120px; padding: 6px 12px;">Kopieren</button>
  </div>
  
  <div style="display: flex; align-items: center; gap: 10px;">
    <label for="importCode" style="min-width: 90px;">Import-Code:</label>
    <input id="importCode" style="width: 300px; padding: 5px;" />
    <button id="importBtn" style="width: 120px; padding: 6px 12px;">Importieren</button>
  </div>
  
  <div>
    <button id="resetBtn" style="width: 200px; padding: 6px 12px;">Alle Zeilen einblenden</button>
  </div>
</div>

  <table>
    <thead>
      <tr>
        <th></th>
        <th data-column-type="text">Hersteller</th>
        <th data-column-type="text">Modell</th>
        <th style="text-align: center;">Bild<br>(klick zum vergrößern)</th>
        <th data-column-type="number">Hubraum (ccm)</th>
        <th data-column-type="text">Leistung<br>(PS @ U/min)</th>
        <th data-column-type="text">Drehmoment<br>(Nm @ U/min)</th>
        <th data-column-type="number">Baujahr</th>
        <th data-column-type="number">Leergewicht<br>(kg)</th>
        <th data-column-type="number">Tankinhalt<br>(L)</th>
        <th data-column-type="number">Preis<br>(UVP)</th>
        <th data-column-type="text">Links</th>
      </tr>
    </thead>
    <tbody id="tabledaten">
      <!-- Zeilen werden dynamisch geladen -->
    </tbody>
  </table>
  
<script>
  document.addEventListener('DOMContentLoaded', function () {
    const STORAGE_KEY = 'versteckteModelle';
    const VERSION_KEY = 'appVersion';
    const CURRENT_VERSION = '1.0.2'; // Aktuelle Version

    // Versionsprüfung und automatische Bereinigung
    const savedVersion = localStorage.getItem(VERSION_KEY);
    if (!savedVersion || savedVersion !== CURRENT_VERSION) {
      localStorage.clear();
      localStorage.setItem(VERSION_KEY, CURRENT_VERSION);
    }

    function getHiddenIDs() {
      return JSON.parse(localStorage.getItem(STORAGE_KEY) || '[]');
    }

    function saveHiddenIDs(ids) {
      localStorage.setItem(STORAGE_KEY, JSON.stringify(ids));
    }

    function updateExportCodeField() {
      const hidden = getHiddenIDs();
      const exportField = document.getElementById('exportCodeField');
      exportField.value = hidden.length ? btoa(JSON.stringify(hidden)) : '';
    }

    fetch('bike_data.html')
      .then(response => response.text())
      .then(data => {
        const tbody = document.getElementById('tabledaten');
        tbody.innerHTML = data;

        const hiddenIDs = getHiddenIDs();

        // Bild-Links setzen
        document.querySelectorAll('td.image-cell').forEach(cell => {
          const imgUrl = cell.getAttribute('data-img-src');
          const anchor = cell.querySelector('a');
          const img = cell.querySelector('img');
          if (imgUrl && anchor && img) {
            anchor.href = imgUrl;
            img.src = imgUrl;
          }
        });

        // Zeilen initialisieren
        document.querySelectorAll('tbody tr').forEach(row => {
          const id = row.getAttribute('data-id');
          const checkbox = row.querySelector('.toggle-row');
          if (!id) return;

          if (hiddenIDs.includes(id)) {
            row.style.display = 'none';
            if (checkbox) checkbox.checked = false;
          }

          if (checkbox) {
            checkbox.addEventListener('change', function () {
              let updated = getHiddenIDs();
              if (!this.checked) {
                row.style.display = 'none';
                if (!updated.includes(id)) updated.push(id);
              } else {
                row.style.display = '';
                updated = updated.filter(x => x !== id);
              }
              saveHiddenIDs(updated);
              updateExportCodeField();
            });
          }
        });

        updateExportCodeField();
      });

    // Tabellen-Sortierung
    const getCellValue = (tr, idx, type) => {
      let val = tr.children[idx]?.innerText || '';
      if (type === 'number') return parseFloat(val.replace('€', '').replace(/\./g, '').replace(',', '.'));
      if (type === 'text') return val.trim().toLowerCase();
      return val;
    };

    const comparer = (idx, asc, type) => (a, b) => {
      const valA = getCellValue(a, idx, type);
      const valB = getCellValue(b, idx, type);
      if (typeof valA === 'number' && typeof valB === 'number') return asc ? valA - valB : valB - valA;
      return asc ? valA.localeCompare(valB) : valB.localeCompare(valA);
    };

    document.querySelectorAll('th').forEach(th => {
      if (th.cellIndex === 3) return; // Bildspalte nicht sortierbar
      let sortDirection = 1;
      th.addEventListener('click', () => {
        const table = th.closest('table');
        const tbody = table.querySelector('tbody');
        const rows = Array.from(tbody.querySelectorAll('tr'));
        const columnIndex = th.cellIndex;
        const columnType = th.getAttribute('data-column-type');
        rows.sort(comparer(columnIndex, sortDirection === 1, columnType));
        sortDirection *= -1;
        rows.forEach(row => tbody.appendChild(row));
      });
    });

    // Reset
    document.getElementById('resetBtn').addEventListener('click', function () {
      localStorage.removeItem(STORAGE_KEY);
      document.querySelectorAll('tbody tr').forEach(row => {
        row.style.display = '';
        const cb = row.querySelector('.toggle-row');
        if (cb) cb.checked = true;
      });
      updateExportCodeField();
    });

    // Import
    document.getElementById('importBtn').addEventListener('click', function () {
      const code = document.getElementById('importCode').value.trim();
      if (!code) return alert('Bitte Code eingeben.');
      let imported;
      try {
        imported = JSON.parse(atob(code));
      } catch (e) {
        return alert('Ungültiger Code!');
      }
      if (!Array.isArray(imported)) return alert('Ungültige Daten!');
      saveHiddenIDs(imported);
      document.querySelectorAll('tbody tr').forEach(row => {
        const id = row.getAttribute('data-id');
        const cb = row.querySelector('.toggle-row');
        if (!id) return;
        if (imported.includes(id)) {
          row.style.display = 'none';
          if (cb) cb.checked = false;
        } else {
          row.style.display = '';
          if (cb) cb.checked = true;
        }
      });
      updateExportCodeField();
      alert('Import abgeschlossen.');
    });

    // Kopieren
    document.getElementById('copyExportBtn').addEventListener('click', () => {
      const exportField = document.getElementById('exportCodeField');
      if (!exportField.value) {
        alert('Kein Exportcode zum Kopieren vorhanden.');
        return;
      }
      navigator.clipboard.writeText(exportField.value).then(() => {
        alert('Exportcode in Zwischenablage kopiert!');
      }, () => {
        alert('Fehler beim Kopieren.');
      });
    });
  });
</script>

</body>
</html>
